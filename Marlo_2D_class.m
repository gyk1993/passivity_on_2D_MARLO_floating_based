classdef Marlo_2D_class <handle
    properties
        g=9.81; %m/s^2
        
        %Leg data
        L1=0.45; %m
        L2=0.5;
        L3=0.5;
        L4=0.5;
        
        m1=0.66149; %kg Maybe four bar linkage (0.6460 in PowerPoint)
        m2=0.68292;
        m3=0.19126;
        m4=0.42493; % Probably lower leg
        
        % Hip data  %%Note that in the planar modoel, the torso and hip are a
        % single unit
        mH = 2*12.84; %kg Mass of Hip
        
        % Torso Data
        LT=0.8; %m
        mT=34.83; %kg Mass of Torso
        % Hip Data
        W=0.165; %m
        
        Jcm1 =0.0228; % kg m^2 Lxx of shin (L1)
        Jcm2 = 0.031; % thigh (L2)
        Jcm3 = 0.0176; % Lxx from four bar linkage.
        Jcm4 = 0.01260;
        
        ellzcm1 = 0.1435; %m shin (L1)
        ellzcm2 = 0.1822; % Z from thigh. (L2)
        ellzcm3 = 0.1137; % Z from Four bar linkage. (L3)
        ellzcm4 = 0.15203; % Z from Lower leg. (L4)
        ellycm1 = -0.0253; % Y from shin. (L1)
        ellycm2 = 0.0157; % Y from thigh. (L2)
        ellycm3 = 0;
        ellycm4 = 0;
        
        % Torso Data
        
        % see [g mTotal m1 m2 m3 m4 mT L1 L2 L3 L4 LT W mH] =  modelParametersAtriasMassLength
        % for mass distribution of torso
        ellzcmT  = 0.6046;
        %ellzcmT  = 0.3;
        ellycmT = 0.0181;
        JcmT = 1.73;
        JcmH=2*0.10791;
        
        %Motor and Gear Reducers
        R1=50;
        R2=50;
        Jgear1 = 2.85377e-3; % kg m^2 SHOULD be the Harmonic Drive Inertia......Current, it is the nominal value from MABEL step down pulley
        Jgear2=2.85377e-3;
        Jrotor1= 7e-4; % kg m^2
        Jrotor2=7e-4;
        
        KJonathan = 1200.0; % N-m/rad.
        Kspring = 50;
        Zeta=.4;
        Kfric_HarmonicDrive = 0*3.2868e+000;
    end
    properties (Dependent)
        mTotal;
        K1;
        K2;
        Kd1;
        Kd2;
    end
    methods
        %         function obj=Marlo_2D_class()
        %             obj.K1= 0.85*obj.KJonathan;
        %             obj.K2=1.1*obj.KJonathan;
        %             %%% Should add dampers here as well.
        %
        %             obj.Kd1 =
        %             obj.Kd2 = 2*obj.Zeta*sqrt(obj.K2);
        %
        %             obj.Kfric_HarmonicDrive = 0*3.2868e+000; %(.3/.26658)*3.2868e+000;
        %         end
        
        
        function [g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
                ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
                JcmT  ellzcmT ellycmT K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  ...
                Jgear2 R1  R2]=get_parameters(obj)
            
            para_vect=[ obj.g obj.mTotal obj.L1 obj.L2 obj.L3 obj.L4 obj.m1 obj.m2 obj.m3 obj.m4 obj.Jcm1 obj.Jcm2 obj.Jcm3 obj.Jcm4 obj.ellzcm1 ...
                obj.ellzcm2 obj.ellzcm3 obj.ellzcm4 obj.ellycm1 obj.ellycm2 obj.ellycm3 obj.ellycm4 obj.LT obj.mT ...
                obj.JcmT obj.ellzcmT obj.ellycmT obj.K1 obj.K2 obj.Kd1 obj.Kd2 obj.Jrotor1 obj.Jrotor2 obj.Jgear1  ...
                obj.Jgear2 obj.R1 obj.R2];
            para_vect=num2cell(para_vect);
            [g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
                ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
                JcmT  ellzcmT ellycmT K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  ...
                Jgear2 R1  R2]=para_vect{:};
        end
        function [D,C,G,B,DampingSpringTorque]= Dynamic_model(obj,q,dq)
            [g mTotal L1 L2 L3 L4 m1 m2 m3 m4 Jcm1 Jcm2 Jcm3 Jcm4 ellzcm1 ...
                ellzcm2 ellzcm3 ellzcm4 ellycm1 ellycm2 ellycm3 ellycm4 LT mT ...
                JcmT  ellzcmT ellycmT K1 K2 Kd1 Kd2 Jrotor1 Jrotor2 Jgear1  ...
                Jgear2 R1  R2] = obj.get_parameters;
            yH=q(1);  dyH=dq(1);
            zH=q(2);  dzH=dq(2);
            
            qT=q(3);  dqT=dq(3);
            q1=q(4);  dq1=dq(4);
            q2=q(5);  dq2=dq(5);
            q1L=q(6);  dq1L=dq(6);
            q2L=q(7);  dq2L=dq(7);
            D=zeros(7,7);
            D(1,1)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mT;
            D(1,3)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
                sin(q1 + qT)))/2 - (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
                sin(q2 + qT)))/2 - (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
                sin(q1L + qT)))/2 - (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
                sin(q2L + qT)))/2 - (m3*(2*L1*cos(q1 + qT) + 2*ellzcm3*...
                cos(q2 + qT) + 2*ellycm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
                cos(q2 + qT) + 2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
                sin(q1 + qT)))/2 - (m3*(2*L1*cos(q1L + qT) + 2*ellzcm3*...
                cos(q2L + qT) + 2*ellycm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
                cos(q2L + qT) + 2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
                sin(q1L + qT)))/2 - (mT*(2*ellzcmT*cos(qT) + 2*ellycmT*...
                sin(qT)))/2;
            D(1,4)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
                sin(q1 + qT)))/2 - (m4*(2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
                sin(q1 + qT)))/2 - L1*m3*cos(q1 + qT);
            D(1,5)=- (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
                sin(q2 + qT)))/2 - (m3*(2*ellzcm3*cos(q2 + qT) + 2*ellycm3*...
                sin(q2 + qT)))/2 - L2*m4*cos(q2 + qT);
            D(1,6)=- (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
                sin(q1L + qT)))/2 - (m4*(2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
                sin(q1L + qT)))/2 - L1*m3*cos(q1L + qT);
            D(1,7)=- (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
                sin(q2L + qT)))/2 - (m3*(2*ellzcm3*cos(q2L + qT) + 2*ellycm3*...
                sin(q2L + qT)))/2 - L2*m4*cos(q2L + qT);
            D(2,2)=2*m1 + 2*m2 + 2*m3 + 2*m4 + mT;
            D(2,3)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
                sin(q1 + qT)))/2 + (m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
                sin(q2 + qT)))/2 + (m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
                sin(q1L + qT)))/2 + (m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
                sin(q2L + qT)))/2 + (mT*(2*ellycmT*cos(qT) - 2*ellzcmT*...
                sin(qT)))/2 - (m3*(2*L1*sin(q1 + qT) - 2*ellycm3*...
                cos(q2 + qT) + 2*ellzcm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
                sin(q2 + qT) - 2*ellycm4*cos(q1 + qT) + 2*ellzcm4*...
                sin(q1 + qT)))/2 - (m3*(2*L1*sin(q1L + qT) - 2*ellycm3*...
                cos(q2L + qT) + 2*ellzcm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
                sin(q2L + qT) - 2*ellycm4*cos(q1L + qT) + 2*ellzcm4*...
                sin(q1L + qT)))/2;
            D(2,4)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
                sin(q1 + qT)))/2 + (m4*(2*ellycm4*cos(q1 + qT) - 2*ellzcm4*...
                sin(q1 + qT)))/2 - L1*m3*sin(q1 + qT);
            D(2,5)=(m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
                sin(q2 + qT)))/2 + (m3*(2*ellycm3*cos(q2 + qT) - 2*ellzcm3*...
                sin(q2 + qT)))/2 - L2*m4*sin(q2 + qT);
            D(2,6)=(m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
                sin(q1L + qT)))/2 + (m4*(2*ellycm4*cos(q1L + qT) - 2*ellzcm4*...
                sin(q1L + qT)))/2 - L1*m3*sin(q1L + qT);
            D(2,7)=(m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
                sin(q2L + qT)))/2 + (m3*(2*ellycm3*cos(q2L + qT) - 2*ellzcm3*...
                sin(q2L + qT)))/2 - L2*m4*sin(q2L + qT);
            D(3,1)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
                sin(q1 + qT)))/2 - (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
                sin(q2 + qT)))/2 - (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
                sin(q1L + qT)))/2 - (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
                sin(q2L + qT)))/2 - (m3*(2*L1*cos(q1 + qT) + 2*ellzcm3*...
                cos(q2 + qT) + 2*ellycm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
                cos(q2 + qT) + 2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
                sin(q1 + qT)))/2 - (m3*(2*L1*cos(q1L + qT) + 2*ellzcm3*...
                cos(q2L + qT) + 2*ellycm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
                cos(q2L + qT) + 2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
                sin(q1L + qT)))/2 - (mT*(2*ellzcmT*cos(qT) + 2*ellycmT*...
                sin(qT)))/2;
            D(3,2)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
                sin(q1 + qT)))/2 + (m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
                sin(q2 + qT)))/2 + (m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
                sin(q1L + qT)))/2 + (m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
                sin(q2L + qT)))/2 + (mT*(2*ellycmT*cos(qT) - 2*ellzcmT*...
                sin(qT)))/2 - (m3*(2*L1*sin(q1 + qT) - 2*ellycm3*...
                cos(q2 + qT) + 2*ellzcm3*sin(q2 + qT)))/2 - (m4*(2*L2*...
                sin(q2 + qT) - 2*ellycm4*cos(q1 + qT) + 2*ellzcm4*...
                sin(q1 + qT)))/2 - (m3*(2*L1*sin(q1L + qT) - 2*ellycm3*...
                cos(q2L + qT) + 2*ellzcm3*sin(q2L + qT)))/2 - (m4*(2*L2*...
                sin(q2L + qT) - 2*ellycm4*cos(q1L + qT) + 2*ellzcm4*...
                sin(q1L + qT)))/2;
            D(3,3)=2*Jcm1 + 2*Jcm2 + 2*Jcm3 + 2*Jcm4 + JcmT + 2*Jgear1 + 2*...
                Jgear2 + 2*Jrotor1 + 2*Jrotor2 + 2*L1^2*m3 + 2*L2^2*m4 + 2*...
                ellycm1^2*m1 + 2*ellzcm1^2*m1 + 2*ellycm2^2*m2 + 2*ellzcm2^2*...
                m2 + 2*ellycm3^2*m3 + 2*ellzcm3^2*m3 + 2*ellycm4^2*m4 + 2*...
                ellzcm4^2*m4 + ellycmT^2*mT + ellzcmT^2*mT + 2*L1*ellzcm3*m3*...
                cos(q1 - q2) + 2*L2*ellzcm4*m4*cos(q1 - q2) + 2*L1*ellzcm3*m3*...
                cos(q1L - q2L) + 2*L2*ellzcm4*m4*cos(q1L - q2L) - 2*L1*ellycm3*...
                m3*sin(q1 - q2) + 2*L2*ellycm4*m4*sin(q1 - q2) - 2*L1*ellycm3*m3*...
                sin(q1L - q2L) + 2*L2*ellycm4*m4*sin(q1L - q2L);
            D(3,4)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
                cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
                sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
            D(3,5)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
                m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
                cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
                sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
            D(3,6)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
                cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
                sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
            D(3,7)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
                m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
                cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
                sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
            D(4,1)=- (m1*(2*ellzcm1*cos(q1 + qT) + 2*ellycm1*...
                sin(q1 + qT)))/2 - (m4*(2*ellzcm4*cos(q1 + qT) + 2*ellycm4*...
                sin(q1 + qT)))/2 - L1*m3*cos(q1 + qT);
            D(4,2)=(m1*(2*ellycm1*cos(q1 + qT) - 2*ellzcm1*...
                sin(q1 + qT)))/2 + (m4*(2*ellycm4*cos(q1 + qT) - 2*ellzcm4*...
                sin(q1 + qT)))/2 - L1*m3*sin(q1 + qT);
            D(4,3)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
                cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
                sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
            D(4,4)=Jcm1 + Jcm4 + Jgear1 + Jrotor1*R1^2 + L1^2*m3 + ellycm1^2*...
                m1 + ellzcm1^2*m1 + ellycm4^2*m4 + ellzcm4^2*m4;
            D(4,5)=L1*ellzcm3*m3*cos(q1 - q2) + L2*ellzcm4*m4*...
                cos(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L2*ellycm4*m4*...
                sin(q1 - q2);
            D(5,1)=- (m2*(2*ellzcm2*cos(q2 + qT) + 2*ellycm2*...
                sin(q2 + qT)))/2 - (m3*(2*ellzcm3*cos(q2 + qT) + 2*ellycm3*...
                sin(q2 + qT)))/2 - L2*m4*cos(q2 + qT);
            D(5,2)=(m2*(2*ellycm2*cos(q2 + qT) - 2*ellzcm2*...
                sin(q2 + qT)))/2 + (m3*(2*ellycm3*cos(q2 + qT) - 2*ellzcm3*...
                sin(q2 + qT)))/2 - L2*m4*sin(q2 + qT);
            D(5,3)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
                m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
                cos(q1 - q2) + L2*ellzcm4*m4*cos(q1 - q2) - L1*ellycm3*m3*...
                sin(q1 - q2) + L2*ellycm4*m4*sin(q1 - q2);
            D(5,4)=L1*ellzcm3*m3*cos(q1 - q2) + L2*ellzcm4*m4*...
                cos(q1 - q2) - L1*ellycm3*m3*sin(q1 - q2) + L2*ellycm4*m4*...
                sin(q1 - q2);
            D(5,5)=Jcm2 + Jcm3 + Jgear2 + Jrotor2*R2^2 + L2^2*m4 + ellycm2^2*...
                m2 + ellzcm2^2*m2 + ellycm3^2*m3 + ellzcm3^2*m3;
            D(6,1)=- (m1*(2*ellzcm1*cos(q1L + qT) + 2*ellycm1*...
                sin(q1L + qT)))/2 - (m4*(2*ellzcm4*cos(q1L + qT) + 2*ellycm4*...
                sin(q1L + qT)))/2 - L1*m3*cos(q1L + qT);
            D(6,2)=(m1*(2*ellycm1*cos(q1L + qT) - 2*ellzcm1*...
                sin(q1L + qT)))/2 + (m4*(2*ellycm4*cos(q1L + qT) - 2*ellzcm4*...
                sin(q1L + qT)))/2 - L1*m3*sin(q1L + qT);
            D(6,3)=Jcm1 + Jcm4 + Jgear1 + L1^2*m3 + ellycm1^2*m1 + ellzcm1^2*...
                m1 + ellycm4^2*m4 + ellzcm4^2*m4 + Jrotor1*R1 + L1*ellzcm3*m3*...
                cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
                sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
            D(6,6)=Jcm1 + Jcm4 + Jgear1 + Jrotor1*R1^2 + L1^2*m3 + ellycm1^2*...
                m1 + ellzcm1^2*m1 + ellycm4^2*m4 + ellzcm4^2*m4;
            D(6,7)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(7,1)=- (m2*(2*ellzcm2*cos(q2L + qT) + 2*ellycm2*...
                sin(q2L + qT)))/2 - (m3*(2*ellzcm3*cos(q2L + qT) + 2*ellycm3*...
                sin(q2L + qT)))/2 - L2*m4*cos(q2L + qT);
            D(7,2)=(m2*(2*ellycm2*cos(q2L + qT) - 2*ellzcm2*...
                sin(q2L + qT)))/2 + (m3*(2*ellycm3*cos(q2L + qT) - 2*ellzcm3*...
                sin(q2L + qT)))/2 - L2*m4*sin(q2L + qT);
            D(7,3)=Jcm2 + Jcm3 + Jgear2 + L2^2*m4 + ellycm2^2*m2 + ellzcm2^2*...
                m2 + ellycm3^2*m3 + ellzcm3^2*m3 + Jrotor2*R2 + L1*ellzcm3*m3*...
                cos(q1L - q2L) + L2*ellzcm4*m4*cos(q1L - q2L) - L1*ellycm3*m3*...
                sin(q1L - q2L) + L2*ellycm4*m4*sin(q1L - q2L);
            D(7,6)=L1*ellzcm3*m3*cos(q1L - q2L) + L2*ellzcm4*m4*...
                cos(q1L - q2L) - L1*ellycm3*m3*sin(q1L - q2L) + L2*ellycm4*m4*...
                sin(q1L - q2L);
            D(7,7)=Jcm2 + Jcm3 + Jgear2 + Jrotor2*R2^2 + L2^2*m4 + ellycm2^2*...
                m2 + ellzcm2^2*m2 + ellycm3^2*m3 + ellzcm3^2*m3;
            %%%%
            %%%%
            %%%%
            %%%%
            C=zeros(7,7);
            C(1,3)=L1*dq1*m3*sin(q1 + qT) + L2*dq2*m4*sin(q2 + qT) + L1*dq1L*...
                m3*sin(q1L + qT) + L2*dq2L*m4*sin(q2L + qT) + L1*dqT*m3*...
                sin(q1 + qT) + L2*dqT*m4*sin(q2 + qT) + L1*dqT*m3*...
                sin(q1L + qT) + L2*dqT*m4*sin(q2L + qT) - dq1*ellycm1*m1*...
                cos(q1 + qT) - dq2*ellycm2*m2*cos(q2 + qT) - dq1*ellycm4*m4*...
                cos(q1 + qT) - dq2*ellycm3*m3*cos(q2 + qT) - dq1L*ellycm1*m1*...
                cos(q1L + qT) - dq2L*ellycm2*m2*cos(q2L + qT) - dq1L*ellycm4*m4*...
                cos(q1L + qT) - dq2L*ellycm3*m3*cos(q2L + qT) - dqT*ellycm1*m1*...
                cos(q1 + qT) - dqT*ellycm2*m2*cos(q2 + qT) - dqT*ellycm3*m3*...
                cos(q2 + qT) - dqT*ellycm4*m4*cos(q1 + qT) - dqT*ellycm1*m1*...
                cos(q1L + qT) - dqT*ellycm2*m2*cos(q2L + qT) - dqT*ellycm3*m3*...
                cos(q2L + qT) - dqT*ellycm4*m4*cos(q1L + qT) + dq1*ellzcm1*m1*...
                sin(q1 + qT) + dq2*ellzcm2*m2*sin(q2 + qT) + dq1*ellzcm4*m4*...
                sin(q1 + qT) + dq2*ellzcm3*m3*sin(q2 + qT) + dq1L*ellzcm1*m1*...
                sin(q1L + qT) + dq2L*ellzcm2*m2*sin(q2L + qT) + dq1L*ellzcm4*m4*...
                sin(q1L + qT) + dq2L*ellzcm3*m3*sin(q2L + qT) + dqT*ellzcm1*m1*...
                sin(q1 + qT) + dqT*ellzcm2*m2*sin(q2 + qT) + dqT*ellzcm3*m3*...
                sin(q2 + qT) + dqT*ellzcm4*m4*sin(q1 + qT) + dqT*ellzcm1*m1*...
                sin(q1L + qT) + dqT*ellzcm2*m2*sin(q2L + qT) + dqT*ellzcm3*m3*...
                sin(q2L + qT) + dqT*ellzcm4*m4*sin(q1L + qT) - dqT*ellycmT*mT*...
                cos(qT) + dqT*ellzcmT*mT*sin(qT);
            C(1,4)=(dq1 + dqT)*(L1*m3*sin(q1 + qT) - ellycm1*m1*...
                cos(q1 + qT) - ellycm4*m4*cos(q1 + qT) + ellzcm1*m1*...
                sin(q1 + qT) + ellzcm4*m4*sin(q1 + qT));
            C(1,5)=(dq2 + dqT)*(L2*m4*sin(q2 + qT) - ellycm2*m2*...
                cos(q2 + qT) - ellycm3*m3*cos(q2 + qT) + ellzcm2*m2*...
                sin(q2 + qT) + ellzcm3*m3*sin(q2 + qT));
            C(1,6)=(dq1L + dqT)*(L1*m3*sin(q1L + qT) - ellycm1*m1*...
                cos(q1L + qT) - ellycm4*m4*cos(q1L + qT) + ellzcm1*m1*...
                sin(q1L + qT) + ellzcm4*m4*sin(q1L + qT));
            C(1,7)=(dq2L + dqT)*(L2*m4*sin(q2L + qT) - ellycm2*m2*...
                cos(q2L + qT) - ellycm3*m3*cos(q2L + qT) + ellzcm2*m2*...
                sin(q2L + qT) + ellzcm3*m3*sin(q2L + qT));
            C(2,3)=- L1*dq1*m3*cos(q1 + qT) - L2*dq2*m4*cos(q2 + qT) - L1*...
                dq1L*m3*cos(q1L + qT) - L2*dq2L*m4*cos(q2L + qT) - L1*dqT*m3*...
                cos(q1 + qT) - L2*dqT*m4*cos(q2 + qT) - L1*dqT*m3*...
                cos(q1L + qT) - L2*dqT*m4*cos(q2L + qT) - dq1*ellzcm1*m1*...
                cos(q1 + qT) - dq2*ellzcm2*m2*cos(q2 + qT) - dq1*ellzcm4*m4*...
                cos(q1 + qT) - dq2*ellzcm3*m3*cos(q2 + qT) - dq1L*ellzcm1*m1*...
                cos(q1L + qT) - dq2L*ellzcm2*m2*cos(q2L + qT) - dq1L*ellzcm4*m4*...
                cos(q1L + qT) - dq2L*ellzcm3*m3*cos(q2L + qT) - dqT*ellzcm1*m1*...
                cos(q1 + qT) - dqT*ellzcm2*m2*cos(q2 + qT) - dqT*ellzcm3*m3*...
                cos(q2 + qT) - dqT*ellzcm4*m4*cos(q1 + qT) - dqT*ellzcm1*m1*...
                cos(q1L + qT) - dqT*ellzcm2*m2*cos(q2L + qT) - dqT*ellzcm3*m3*...
                cos(q2L + qT) - dqT*ellzcm4*m4*cos(q1L + qT) - dq1*ellycm1*m1*...
                sin(q1 + qT) - dq2*ellycm2*m2*sin(q2 + qT) - dq1*ellycm4*m4*...
                sin(q1 + qT) - dq2*ellycm3*m3*sin(q2 + qT) - dq1L*ellycm1*m1*...
                sin(q1L + qT) - dq2L*ellycm2*m2*sin(q2L + qT) - dq1L*ellycm4*m4*...
                sin(q1L + qT) - dq2L*ellycm3*m3*sin(q2L + qT) - dqT*ellycm1*m1*...
                sin(q1 + qT) - dqT*ellycm2*m2*sin(q2 + qT) - dqT*ellycm3*m3*...
                sin(q2 + qT) - dqT*ellycm4*m4*sin(q1 + qT) - dqT*ellycm1*m1*...
                sin(q1L + qT) - dqT*ellycm2*m2*sin(q2L + qT) - dqT*ellycm3*m3*...
                sin(q2L + qT) - dqT*ellycm4*m4*sin(q1L + qT) - dqT*ellzcmT*mT*...
                cos(qT) - dqT*ellycmT*mT*sin(qT);
            C(2,4)=-(dq1 + dqT)*(L1*m3*cos(q1 + qT) + ellzcm1*m1*...
                cos(q1 + qT) + ellzcm4*m4*cos(q1 + qT) + ellycm1*m1*...
                sin(q1 + qT) + ellycm4*m4*sin(q1 + qT));
            C(2,5)=-(dq2 + dqT)*(L2*m4*cos(q2 + qT) + ellzcm2*m2*...
                cos(q2 + qT) + ellzcm3*m3*cos(q2 + qT) + ellycm2*m2*...
                sin(q2 + qT) + ellycm3*m3*sin(q2 + qT));
            C(2,6)=-(dq1L + dqT)*(L1*m3*cos(q1L + qT) + ellzcm1*m1*...
                cos(q1L + qT) + ellzcm4*m4*cos(q1L + qT) + ellycm1*m1*...
                sin(q1L + qT) + ellycm4*m4*sin(q1L + qT));
            C(2,7)=-(dq2L + dqT)*(L2*m4*cos(q2L + qT) + ellzcm2*m2*...
                cos(q2L + qT) + ellzcm3*m3*cos(q2L + qT) + ellycm2*m2*...
                sin(q2L + qT) + ellycm3*m3*sin(q2L + qT));
            C(3,3)=dq2*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2)) - dq1*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2)) - dq1L*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L)) + dq2L*(L1*ellycm3*m3*cos(q1L - q2L) - L2*...
                ellycm4*m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*...
                ellzcm4*m4*sin(q1L - q2L));
            C(3,4)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2));
            C(3,5)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2));
            C(3,6)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(3,7)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(4,3)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2));
            C(4,5)=(dq2 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2));
            C(5,3)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2));
            C(5,4)=-(dq1 + dqT)*(L1*ellycm3*m3*cos(q1 - q2) - L2*ellycm4*m4*...
                cos(q1 - q2) + L1*ellzcm3*m3*sin(q1 - q2) + L2*ellzcm4*m4*...
                sin(q1 - q2));
            C(6,3)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(6,7)=(dq2L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(7,3)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            C(7,6)=-(dq1L + dqT)*(L1*ellycm3*m3*cos(q1L - q2L) - L2*ellycm4*...
                m4*cos(q1L - q2L) + L1*ellzcm3*m3*sin(q1L - q2L) + L2*ellzcm4*m4*...
                sin(q1L - q2L));
            %%%%
            %%%%
            %%%%
            %%%%
            G=zeros(7,1);
            G(1)=0;
            G(2)=g*(2*m1 + 2*m2 + 2*m3 + 2*m4 + mT);
            G(3)=-g*(ellzcmT*mT*sin(qT) - ellycmT*mT*cos(qT) + L1*m3*...
                sin(q1 + qT) + L2*m4*sin(q2 + qT) + L1*m3*sin(q1L + qT) + L2*m4*...
                sin(q2L + qT) - ellycm1*m1*cos(q1 + qT) - ellycm2*m2*...
                cos(q2 + qT) - ellycm3*m3*cos(q2 + qT) - ellycm4*m4*...
                cos(q1 + qT) - ellycm1*m1*cos(q1L + qT) - ellycm2*m2*...
                cos(q2L + qT) - ellycm3*m3*cos(q2L + qT) - ellycm4*m4*...
                cos(q1L + qT) + ellzcm1*m1*sin(q1 + qT) + ellzcm2*m2*...
                sin(q2 + qT) + ellzcm3*m3*sin(q2 + qT) + ellzcm4*m4*...
                sin(q1 + qT) + ellzcm1*m1*sin(q1L + qT) + ellzcm2*m2*...
                sin(q2L + qT) + ellzcm3*m3*sin(q2L + qT) + ellzcm4*m4*...
                sin(q1L + qT));
            G(4)=-g*(L1*m3*sin(q1 + qT) - ellycm1*m1*cos(q1 + qT) - ellycm4*...
                m4*cos(q1 + qT) + ellzcm1*m1*sin(q1 + qT) + ellzcm4*m4*...
                sin(q1 + qT));
            G(5)=-g*(L2*m4*sin(q2 + qT) - ellycm2*m2*cos(q2 + qT) - ellycm3*...
                m3*cos(q2 + qT) + ellzcm2*m2*sin(q2 + qT) + ellzcm3*m3*...
                sin(q2 + qT));
            G(6)=-g*(L1*m3*sin(q1L + qT) - ellycm1*m1*...
                cos(q1L + qT) - ellycm4*m4*cos(q1L + qT) + ellzcm1*m1*...
                sin(q1L + qT) + ellzcm4*m4*sin(q1L + qT));
            G(7)=-g*(L2*m4*sin(q2L + qT) - ellycm2*m2*...
                cos(q2L + qT) - ellycm3*m3*cos(q2L + qT) + ellzcm2*m2*...
                sin(q2L + qT) + ellzcm3*m3*sin(q2L + qT));
            %%%%
            %%%%
            %%%%
            %%%%
            B=zeros(7,4);
            B(4,1)=R1;
            B(5,2)=R2;
            B(6,3)=R1;
            B(7,4)=R2;
            %%%%
            %%%%
            DampingSpringTorque=zeros(7,1);
            DampingSpringTorque(1)=0;
            DampingSpringTorque(2)=0;
            DampingSpringTorque(3)=0;
            DampingSpringTorque(4)=0;
            DampingSpringTorque(5)=0;
            DampingSpringTorque(6)=0;
            DampingSpringTorque(7)=0;
        end
        function [ER,dER]=get_ER(obj,x)
            q1=x(1); dq1=x(8);
            q2=x(2); dq2=x(9);
            q3=x(3); dq3=x(10);
            q4=x(4); dq4=x(11);
            q5=x(5); dq5=x(12);
            q6=x(6); dq6=x(13);
            q7=x(7); dq7=x(14);
            
            qT=x(3);
            q1R=x(4);
            q2R=x(5);
            q1L=x(6);
            q2L=x(7);
            
            ER=[1,                                   0
                0,                                   1
                - cos(q1R + qT)/2 - cos(q2R + qT)/2, - sin(q1R + qT)/2 - sin(q2R + qT)/2
                -cos(q1R + qT)/2,                    -sin(q1R + qT)/2
                -cos(q2R + qT)/2,                    -sin(q2R + qT)/2
                0,                                   0
                0,                                   0];
            ER=ER';
            
            dER=[ 0, 0,   dq3*(sin(q3 + q4)/2 + sin(q3 + q5)/2) + (dq4*sin(q3 + q4))/2 + (dq5*sin(q3 + q5))/2,   (dq3*sin(q3 + q4))/2 + (dq4*sin(q3 + q4))/2,   (dq3*sin(q3 + q5))/2 + (dq5*sin(q3 + q5))/2, 0, 0
                0, 0, - dq3*(cos(q3 + q4)/2 + cos(q3 + q5)/2) - (dq4*cos(q3 + q4))/2 - (dq5*cos(q3 + q5))/2, - (dq3*cos(q3 + q4))/2 - (dq4*cos(q3 + q4))/2, - (dq3*cos(q3 + q5))/2 - (dq5*cos(q3 + q5))/2, 0, 0];
        end
        function value=get.mTotal(obj)
            value = 2*(obj.m1 + obj.m2 + obj.m3 + obj.m4) + obj.mT + obj.mH;
        end
        function value=get.K1(obj)
            value = 0.85*obj.KJonathan;
        end
        function value=get.K2(obj)
            value = 1.1*obj.KJonathan;
        end
        function value=get.Kd1(obj)
            value = 2*obj.Zeta*sqrt(obj.K1);
        end
        function value=get.Kd2(obj)
            value = 2*obj.Zeta*sqrt(obj.K2);
        end
    end   
end



        